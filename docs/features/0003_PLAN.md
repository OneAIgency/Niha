# Plan: Scraping Tool with Yuan→EUR Conversion + DOM Visualization Tool

## Description

Two related additions:

1. **Scraping tool with always yuan→EUR conversion:** The platform’s price-scraping pipeline must **always** convert yuan (CNY) to EUR. CEA sources scrape prices in yuan; those values must be converted to EUR at scrape/refresh time and stored/displayed **only** in EUR everywhere (Settings, Price History, APIs).

2. **DOM visualization tool:** A small tool to visualize and target the **Price Scraping Sources** section in the Settings UI. Target element: the Card that wraps the “Price Scraping Sources” table (Add Source, SOURCE TYPE, LIBRARY, INTERVAL, LAST SCRAPE, LAST PRICE, STATUS, ACTIONS). The tool must support reliable DOM targeting (e.g. via stable `data-*` attributes) and, where useful, display of the canonical DOM path, scroll-into-view, and optional highlight for that section.

---

## Relevant Files and Functions

### Backend

| File | Change |
|------|--------|
| `backend/app/services/price_scraper.py` | `scrape_source`, `_scrape_carboncredits`, `_extract_price`, `refresh_source`. For CEA sources: treat scraped value as CNY; convert to EUR via `currency_service.convert(..., "CNY", "EUR")` before returning or storing. Store `PriceHistory` with `currency="EUR"` and `price` in EUR for CEA. |
| `backend/app/services/currency_service.py` | No change. Already used for CNY→EUR; keep as single place for conversion. |

### Frontend

| File | Change |
|------|--------|
| `frontend/src/pages/SettingsPage.tsx` | (1) Always display `last_price` and test `price` in EUR (`formatCurrency(..., 'EUR')`), regardless of `certificate_type`. Remove `¥` for CEA. (2) Add stable attributes to the Price Scraping Sources Card: `data-testid="price-scraping-sources-card"` and, if useful, `data-component="PriceScrapingSources"`. (3) Add DOM visualization: e.g. a “Show DOM path” / “Visualize” control in the section header that toggles a small inline panel showing the canonical path, “Scroll into view,” and optional highlight. |
| `frontend/src/utils/index.ts` | `formatCurrency` already supports EUR; no change unless a shared DOM-path helper is added. |
| `frontend/src/types/index.ts` | `ScrapingSource.last_price` remains numeric; semantics change to “always EUR.” No type change required. |

### API

| File | Change |
|------|--------|
| `backend/app/api/v1/admin.py` | `test_scraping_source`, `refresh_scraping_source`, `get_scraping_sources`. No schema changes. Backend now returns `last_price` in EUR for CEA; frontend already consumes numeric `price` / `last_price`. |

---

## DOM Target (Verbatim)

- **Path:** `div#root > div.min-h-screen.flex.flex-col.bg-navy-50.dark:bg-navy-950 > main.flex-1.pt-20 > div.min-h-screen.bg-slate-950 > div.max-w-7xl.mx-auto.px-4.sm:px-6.lg:px-8.py-8 > div.space-y-8 > div > div.bg-white.dark:bg-navy-800.rounded-2xl.shadow-lg.border.border-navy-100.dark:border-navy-700.p-6`
- **Position (reference):** top=193px, left=32px, width=1120px, height=324px.
- **React component:** Section that renders the “Price Scraping Sources” Card (currently in `SettingsPage`).
- **HTML element:** The `div` with classes `bg-white dark:bg-navy-800 rounded-2xl shadow-lg border border-navy-100 dark:border-navy-700 p-6` (the Card wrapper).

The DOM visualization tool must target this exact Card. Use the canonical path above (with correct class names) for the “DOM path” display.

---

## Algorithms

### Yuan→EUR conversion (scraping pipeline)

1. Scrape runs as today (HTTPX, BeautifulSoup, Selenium, Playwright, or carboncredits.com-specific logic).
2. Extract raw numeric price from the page/API. For **CEA** sources, treat this as **CNY**.
3. If `certificate_type == CEA`:
   - Call `currency_service.convert(Decimal(price), "CNY", "EUR")`.
   - Use the converted value (in EUR) as the price for all downstream use.
4. If `certificate_type == EUA`: keep value as EUR; no conversion.
5. In `refresh_source`: store `last_price` and `PriceHistory.price` in EUR. Always set `PriceHistory.currency = "EUR"` for both EUA and CEA.
6. `scrape_source` (used by test endpoint): return price already in EUR for CEA.

### DOM visualization tool

1. The Price Scraping Sources Card is marked with `data-testid="price-scraping-sources-card"` (and optionally `data-component="PriceScrapingSources"`).
2. A small UI control in that section (e.g. “Show DOM path” / “Visualize”) toggles an inline panel.
3. The panel shows the **canonical DOM path** (see above) for that Card.
4. Actions: “Scroll into view” (scroll the Card into view), and optionally “Highlight” (e.g. temporary outline/background) to make the element visible in the layout.
5. Reuse existing layout and styles (Tailwind, `Card`, `Subheader`) so the new controls match the rest of Settings.

---

## Consistency and Conventions

- **CSS / components:** Reuse existing `Card`, `Button`, `Badge`, and Tailwind tokens. No new design system.
- **Backend:** Keep `currency_service` as the only place for forex conversion. Use it in `price_scraper` for CEA.
- **Data:** All scraping-derived prices shown or stored in the platform are in EUR. No mock or demo data; use real DB/API.

---

## UI Spec

If needed, create `docs/features/0003_UI_SPEC.md` via `@interface.md` for the DOM visualization UI (placement of “Show DOM path” / “Visualize,” panel layout, and actions). The plan assumes a minimal inline control + small panel; a spec can formalize that.

---

## Phases

Not split into phases. The work is scoped to the scraper, Settings UI, and the DOM visualization toggle/panel; it can be implemented in a single pass.
