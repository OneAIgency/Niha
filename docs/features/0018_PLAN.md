# 0018 – Add Asset Modal: Deposit and Withdraw Buttons

## Context

The **Add Asset** modal (used when editing entity balances from User Detail in Backoffice) currently has a single "Amount to Add" field and one "Add {asset}" button. Withdrawals are not supported explicitly. The user wants two distinct actions:

- **Deposit**: add the amount to the entity balance
- **Withdraw**: subtract the amount from the entity balance

User requirements (verbatim):

- *"Amount to add changes to 2 buttons: Deposit and Withdraw. In deposit we add the amount in Withdraw we withdraw the amount"*

---

## Files to Modify

### Backend

| File | Changes |
|------|---------|
| `backend/app/schemas/schemas.py` | Extend `AddAssetRequest` to support both operations: add optional `operation: Literal["deposit", "withdraw"]` (default `"deposit"`), keep `amount` positive (`gt=0`), or introduce a separate schema `AssetAdjustmentRequest` if preferred |
| `backend/app/api/v1/backoffice.py` | In `add_asset_to_entity`: accept operation type; for `withdraw`, validate sufficient balance before deducting, use `TransactionType.WITHDRAWAL` and pass negative amount to balance update |

### Frontend

| File | Changes |
|------|---------|
| `frontend/src/services/api.ts` | Extend `backofficeApi.addAsset` request type to include `operation?: 'deposit' \| 'withdraw'` |
| `frontend/src/components/backoffice/AddAssetModal.tsx` | Change "Amount to Add" label to "Amount"; replace single "Add {asset}" button with two buttons: **Deposit** (adds amount) and **Withdraw** (withdraws amount); validate on Withdraw that amount ≤ current balance |

---

## Technical Details

### Backend Logic

1. **Schema**

   - Add `operation: Literal["deposit", "withdraw"] = "deposit"` to `AddAssetRequest`.
   - Keep `amount: float = Field(..., gt=0)` so amount is always positive; sign is determined by `operation`.

2. **Endpoint `add_asset_to_entity`**

   - If `operation == "withdraw"`:
     - Compute `amount_debit = -abs(amount)`.
     - Get current balance via existing `holding.quantity`.
     - If `balance_before + amount_debit < 0`, raise `HTTPException(400, "Insufficient balance")`.
     - Update holding: `balance_after = balance_before + amount_debit`.
     - Create `AssetTransaction` with `transaction_type=TransactionType.WITHDRAWAL`, `amount=amount_debit`.
   - If `operation == "deposit"`:
     - Keep existing behaviour: add positive amount, use `TransactionType.DEPOSIT`.

3. **Consistency**

   - Prefer reusing `balance_utils.update_entity_balance` if it supports negative amounts and `TransactionType.WITHDRAWAL`; otherwise keep inline logic in the endpoint but ensure audit trail uses correct transaction type.

### Frontend Logic

1. **Label**

   - Change "Amount to Add *" to "Amount *" (neutral for both operations).

2. **Amount validation**

   - Both buttons require `amount > 0`.
   - Withdraw: additionally require `amount <= getCurrentBalance()`; show error if insufficient balance.

3. **Buttons**

   - **Deposit**: primary (emerald) style, icon `Plus`; calls `addAsset` with `operation: 'deposit'`.
   - **Withdraw**: secondary/destructive style (e.g. `variant="secondary"` with red/warning styling), icon `Minus` or `ArrowDownCircle`; calls `addAsset` with `operation: 'withdraw'`.

4. **New Balance preview**

   - Show for both operations when amount is valid.
   - Deposit: `newBalance = currentBalance + amount`.
   - Withdraw: `newBalance = currentBalance - amount`; hide or show warning if result < 0.

5. **Error handling**

   - Map backend "Insufficient balance" to a clear message in the modal.

---

## UI Consistency

- Use existing `Button`, `AlertBanner`, and design tokens from `DESIGN_SYSTEM.md`.
- Withdraw button: follow destructive/warning pattern (e.g. `text-red-600` / `hover:bg-red-500/10`) as used elsewhere (e.g. MyOrders Cancel in 0016_PLAN).
