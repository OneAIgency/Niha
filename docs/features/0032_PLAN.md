# 0032 – Pagină Introducer, rol INTRODUCER, conținut simplificat

Plan tehnic pentru: (1) pagină nouă de start la `/introducer` cu butoane ENTER și NDA; (2) rol nou de utilizator INTRODUCER; (3) după validarea contului, acces la un conținut mult mai simplu și mai discret decât cel pentru cumpărători (utilizatori finali).

---

## 1. Context

- **Surse:** `app_truth.md`, `docs/ROLE_TRANSITIONS.md`, `frontend/docs/DESIGN_SYSTEM.md`, `.cursor/rules/niha-core.mdc`.
- **Cerințe utilizator:**
  - Pagină nouă de start cu link `/introducer`.
  - Conține aceleași două butoane: **ENTER** și **NDA**.
  - Rol nou: **INTRODUCER**.
  - După validarea contului: acces la un conținut mult mai simplu și mai discret decât cel pentru cumpărători (utilizatori finali).
- **Fără mock, demo sau cache** – toate datele din DB/API.

---

## 2. Fișiere și funcții relevante

| Zonă | Fișier | Elemente |
|------|--------|----------|
| **Backend – modele** | `backend/app/models/models.py` | `UserRole` (adaugă INTRODUCER), `ContactRequest` (adaugă `request_flow` sau `target_role`) |
| **Backend – contact** | `backend/app/api/v1/contact.py` | Endpoint nou `POST /contact/introducer-nda-request` sau parametru `flow` la nda-request |
| **Backend – admin** | `backend/app/api/v1/admin.py` | `create_user_from_contact_request` – parametru opțional `target_role`; când INTRODUCER: user fără entity |
| **Backend – securitate** | `backend/app/core/security.py` | `get_introducer_user` sau `get_onboarding_user` extins pentru INTRODUCER |
| **Backend – migrații** | `backend/alembic/versions/` | Migrație: enum `userrole` + `contact_requests.request_flow` (dacă se folosește) |
| **Frontend – tipuri** | `frontend/src/types/index.ts` | `UserRole` – adaugă `'INTRODUCER'` |
| **Frontend – pagină** | `frontend/src/pages/IntroducerPage.tsx` | Pagină nouă: ENTER + NDA (reutilizare logică LoginPage, fără a modifica LoginPage – frozen) |
| **Frontend – API** | `frontend/src/services/api.ts` | `contactApi.submitIntroducerNDARequest` sau parametru la `submitNDARequest` |
| **Frontend – rute** | `frontend/src/App.tsx` | Ruta `/introducer`, `IntroducerRoute`, `CatchAllRedirect` |
| **Frontend – redirect** | `frontend/src/utils/redirect.ts` | `getPostLoginRedirect` – caz INTRODUCER → `/introducer/dashboard` |
| **Frontend – effectiveRole** | `frontend/src/utils/effectiveRole.ts` | `USER_ROLES` – adaugă INTRODUCER |
| **Frontend – dashboard** | `frontend/src/pages/IntroducerDashboardPage.tsx` | Conținut simplificat și discret |
| **Frontend – Header** | `frontend/src/components/layout/Header.tsx` | Scurtătură/logo pentru INTRODUCER (opțional) |
| **Frontend – roleBadge** | `frontend/src/utils/roleBadge.ts` | Caz INTRODUCER |
| **Backoffice** | `frontend/src/components/backoffice/ContactRequestsTab.tsx`, `ApproveInviteModal.tsx` | Filtru/tab cereri introducer; Approve cu `target_role=INTRODUCER` |
| **Tranziții** | `docs/ROLE_TRANSITIONS.md` | NDA (introducer) → INTRODUCER prin create-from-request cu target_role |

---

## 3. Algoritm și fluxuri

### 3.1 Pagina `/introducer`

- Acces public (neautentificat) – similar `/login`.
- **ENTER:** buton → formular email + parolă → login. După login, `getPostLoginRedirect` redirecționează INTRODUCER la `/introducer/dashboard`.
- **NDA:** buton → formular NDA (entity, email, first/last name, position, PDF) → submit la `POST /api/v1/contact/introducer-nda-request`. Mesaj succes „Request Submitted”, comportament similar LoginPage NDA (opțional: animație ambient după 5s).
- Dacă utilizatorul e deja autentificat cu rol INTRODUCER, redirect la `/introducer/dashboard`.
- Design: același stil vizual ca LoginPage (fără a refactoriza LoginPage – frozen). Pagina nouă poate reutiliza componente și animații din `LoginPageAnimations.tsx`.

### 3.2 Rol INTRODUCER

- **Backend:** adăugare `INTRODUCER = "INTRODUCER"` în `UserRole` enum; migrație Alembic pentru `userrole`.
- **Frontend:** adăugare `'INTRODUCER'` în `UserRole` și `USER_ROLES`.
- **Tranziție:** cereri NDA cu flow introducer → admin Approve & Create User cu `target_role=INTRODUCER` → user creat cu `role=INTRODUCER`, `entity_id=null`.
- **Acces API:** endpoint(e) pentru conținutul INTRODUCER trebuie protejate cu `get_introducer_user` (INTRODUCER sau ADMIN).

### 3.3 Cereri NDA pentru Introducer

- **Opțiune A:** coloană `request_flow` în `contact_requests` (`'buyer'` | `'introducer'`), default `'buyer'`. Migrație pentru coloană nouă.
- **Opțiune B:** endpoint separat `POST /contact/introducer-nda-request` – același payload ca nda-request; backend creează `ContactRequest` cu flag sau metadata pentru flow introducer (ex. `request_flow='introducer'` în DB).
- Backoffice: filtrare sau tab separat pentru cereri introducer; buton Approve deschide `ApproveInviteModal` cu `target_role='INTRODUCER'`.
- `create-from-request`: parametru Query opțional `target_role` (default `KYC`). Când `target_role=INTRODUCER`: user cu `role=UserRole.INTRODUCER`, `entity_id=null`; nu se creează Entity. `contact_request.user_role` poate rămâne NDA sau se introduce ContactStatus.INTRODUCER_APPROVED dacă e nevoie (sau se folosește un câmp auxiliar).

### 3.4 Conținut simplificat pentru INTRODUCER

- Ruta `/introducer/dashboard` (sau `/introducer` când e autentificat) – pagină dedicată cu conținut mult mai simplu și discret:
  - Fără: cash market, swap, funding, settlements, balanțe EUR/CEA/EUA.
  - Cu: prezentare sumară, eventual prețuri de referință (dacă e cerut), linkuri/call-to-action discrete.
- Layout: `Layout` (Header + Footer) pentru consistență; conținutul din main e minimalist.
- Componentă nouă: `IntroducerDashboardPage.tsx` – design discret, token-uri din design system (navy, emerald).

### 3.5 Protecție rute și redirecturi

- `getPostLoginRedirect`: caz `role === 'INTRODUCER'` → return `'/introducer/dashboard'`.
- `IntroducerRoute`: `allowedRoles={['INTRODUCER', 'ADMIN']}` pentru `/introducer` și `/introducer/dashboard`.
- `ProtectedRoute` / `DashboardRoute`: INTRODUCER nu are acces la `/dashboard`, `/funding`, `/cash-market`, `/swap` – aceste rute continuă să accepte doar rolurile existente (AML, CEA, …, EUA, ADMIN, MM).
- CatchAllRedirect: INTRODUCER autentificat la rute necunoscute → redirect la `/introducer/dashboard`.
- LoginRoute pentru `/introducer`: neautentificat vede ENTER/NDA; autentificat INTRODUCER → redirect la `/introducer/dashboard`.

---

## 4. Backoffice – cereri Introducer

- Lista Contact Requests: filtrare după `request_flow === 'introducer'` sau tab „Introducer requests”.
- Approve pentru cerere introducer → `ApproveInviteModal` cu `targetRole: 'INTRODUCER'` → submit la `create-from-request` cu `target_role=INTRODUCER`.
- ContactStatus: poate rămâne NDA până la approve; la approve se setează `user_role` la KYC-equivalent pentru introducer (sau un nou ContactStatus INTRODUCER_PENDING/APPROVED) – de aliniat cu schema DB. Simplu: păstrăm NDA, iar create-from-request creează user INTRODUCER indiferent de user_role pe contact_request (citim request_flow din contact_request).

---

## 5. Migrații

- Adăugare valoare `INTRODUCER` în enum PostgreSQL `userrole`.
- Adăugare coloană `request_flow` în `contact_requests` (VARCHAR sau ENUM `'buyer'`, `'introducer'`), default `'buyer'`.
- `down_revision` = migrația head curentă (ex. `2026_02_13_spread_and_tick_size` sau cea returnată de `alembic current`).

---

## 6. Reguli și constrângeri

- **Frozen files:** Nu se modifică `LoginPage.tsx`, `LoginPageAnimations.tsx`, `Onboarding1Page.tsx` (doar se citește pentru pattern). `IntroducerPage.tsx` e o pagină nouă care reproduce pattern-ul.
- **Design system:** Token-uri navy, emerald; fără slate/gray; componente din `frontend/src/components/common/`.
- **Client state:** User state derivat doar din `User.role`; ContactRequest state din `user_role` și `request_flow`.
- **ROLE_TRANSITIONS.md:** Actualizare cu tranziția NDA (introducer) → INTRODUCER prin create-from-request.

---

## 7. Checklist implementare

- [ ] Backend: UserRole.INTRODUCER, migrație enum
- [ ] Backend: ContactRequest.request_flow, migrație
- [ ] Backend: POST /contact/introducer-nda-request
- [ ] Backend: create-from-request cu target_role INTRODUCER
- [ ] Backend: get_introducer_user dependency
- [ ] Frontend: UserRole 'INTRODUCER', USER_ROLES
- [ ] Frontend: IntroducerPage (ENTER + NDA)
- [ ] Frontend: contactApi.submitIntroducerNDARequest
- [ ] Frontend: rute /introducer, /introducer/dashboard
- [ ] Frontend: getPostLoginRedirect pentru INTRODUCER
- [ ] Frontend: IntroducerDashboardPage (conținut simplificat)
- [ ] Frontend: roleBadge pentru INTRODUCER
- [ ] Backoffice: filtrare/tab cereri introducer, Approve cu target_role
- [ ] docs/ROLE_TRANSITIONS.md actualizat
- [ ] app_truth.md actualizat (§8 routing, roluri)
