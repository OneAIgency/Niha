# 0025 – AML: WebSocket role update live + modal click-to-dismiss, dashboard blur persists

## Descriere

Pentru un **client cu rol AML**:

1. **Actualizare live la schimbarea rolului**: Când adminul confirmă clear pe deposit (AML→CEA), pagina utilizatorului AML trebuie să se actualizeze **în timp real** prin WebSocket, fără refresh manual.
2. **Modal AML review – dismiss la click**: Când utilizatorul AML dă **click oriunde** pe pagină, modalul AML review dispare.
3. **Dashboard rămâne blurred**: După ce modalul dispare, overlay-ul de blur de pe dashboard rămâne activ (utilizatorul vede tot dashboard-ul blurat, dar fără modal).

## Fișiere relevante

### Backend
- `backend/app/api/v1/` – nou router sau modul pentru WebSocket client (autentificat per-user)
- `backend/app/api/v1/deposits.py` – apel `clear_deposit`; după commit, notificare către client WebSocket manager
- `backend/app/main.py` – înregistrare rute noi pentru client WS
- `backend/app/core/security.py` – verificare JWT pentru WebSocket client (dacă se folosește query param / header)
- `app_truth.md` – mențiune nouă despre client WebSocket pentru role updates

### Frontend
- `frontend/src/pages/DashboardPage.tsx` – stare `showAmlModal`, click-to-dismiss, blur independent de modal; integrare hook client WS pentru refresh user
- `frontend/src/services/api.ts` – API client WebSocket pentru utilizatori (connect, onMessage, tipuri)
- `frontend/src/hooks/` – hook nou `useClientRealtime` sau similar (conectare WS client, subscription `role_updated`, refetch user)
- `frontend/src/stores/useStore.ts` – `setAuth` pentru actualizare user la primire event role
- `frontend/src/types/index.ts` – tipuri pentru mesaje client WebSocket

## Specificații tehnice

### 1. Modal click-to-dismiss + blur persistă

**Algoritm:**
- Stare nouă: `showAmlModal: boolean` – implicit `true` când `isAmlUser` este true.
- **Blur overlay**: Afișat când `isAmlUser` (fără condiție pe modal).
- **Modal**: Afișat când `isAmlUser && showAmlModal`.
- La **prima acțiune de click** oriunde în viewport (inclusiv pe overlay blur, nu doar pe modal): `setShowAmlModal(false)`. Modalul dispare cu AnimatePresence exit; blur rămâne.
- `showAmlModal` se resetează la `true` când utilizatorul revine pe dashboard cu rol AML (ex. la mount sau când `isAmlUser` devine true din nou – deși în practică rolul AML nu revine decât dacă simulăm).

**Implementare:**
- Wrapper cu `onClick` pe div-ul fix care conține blur + modal (sau pe overlay blur). Click pe interiorul modalului: propagare opțională – dacă se dorește ca click pe conținutul modalului să închidă și el modalul, atunci nu se face stopPropagation; altfel doar click pe backdrop (overlay) închide. Utilizatorul a spus „click oriunde” – deci orice click (inclusiv pe modal) închide modalul.
- Evitare: click pe butoane din modal (dacă există) – dacă nu există butoane interactive, orice click e OK.

### 2. Client WebSocket – actualizare rol live

**Backend:**
- **Client WebSocket manager**: Nou manager (ex. `ClientConnectionManager`) care păstrează conexiuni mapate pe `user_id`. La connect: acceptă WebSocket, validează JWT (query param `?token=...` sau header), extrage `user_id`, înregistrează conexiunea.
- **Endpoint**: `WS /api/v1/client/ws` sau `/api/v1/users/me/ws` – autentificat, un singur connection per user (opțional: replace la reconectare).
- **Event la clear deposit**: După `clear_deposit` și commit, backend obține lista de `user_id` pentru entity-ul afectat (cei care erau AML și au trecut la CEA). Trimite prin manager: `broadcast_to_users(user_ids, {"type": "role_updated", "data": {"role": "CEA", ...}})`.
- **Payload sugerat**: `{ type: "role_updated", data: { role: "CEA", entity_id?: string } }` – frontend poate refetch `GET /users/me` și actualiza auth store.

**Frontend:**
- **Hook `useClientRealtime`**: Conectează la WebSocket client când user este autentificat și (opțional) când e pe rute care beneficiază de live updates (ex. dashboard, funding). La primire `role_updated`: apelează `usersApi.getProfile()`, apoi `useAuthStore.getState().setAuth(updatedUser, token)` (token-ul rămâne același). Opțional: redirecționare via `getPostLoginRedirect` dacă rolul nou implică altă pagină (ex. AML→CEA poate rămâne pe dashboard, dar conținutul se actualizează).
- **Montare hook**: În `DashboardPage` sau la nivel de Layout pentru utilizatori autentificați (ex. în App.tsx, în interiorul Layout, doar când `isAuthenticated`). Preferabil la nivel înalt (ex. Layout) pentru a acoperi și alte pagini unde rolul contează.

### 3. Integrare în fluxul existent

- `deposits.py` – funcția `clear_deposit` (endpoint POST `/{deposit_id}/clear`): după `db.commit()`, obține user IDs din entity pentru utilizatorii care au fost actualizați (AML→CEA). Apelează `client_ws_manager.broadcast_to_users(user_ids, {"type": "role_updated", "data": {"role": "CEA"}})`.
- Consistență cu `app_truth.md` §8: User.role este SSOT; WebSocket-ul doar notifică frontend-ul să refetch user și să actualizeze UI.

## Consistență cu app_truth și design

- **app_truth.md**: Adăugare paragraf despre Client WebSocket: utilizatori autentificați (în special AML, dar și alții) pot primi evenimente `role_updated` când rolul se schimbă pe backend (ex. clear deposit AML→CEA). Frontend refetch-ează `/users/me` și actualizează auth store.
- **Design**: Modal și blur folosesc deja token-uri existente; `stopPropagation` / handler de click trebuie aplicat corect pentru a nu interfera cu elementele interactive din conținut (dacă există).

## Algoritm pas cu pas

### Modal + blur
1. La mount: `showAmlModal = isAmlUser` (sau `true` când `isAmlUser`).
2. Render blur: `{isAmlUser && <div className="fixed inset-0 z-40" ... />}` (fără `showAmlModal`).
3. Render modal: `{isAmlUser && showAmlModal && <motion.div ... onClick={...} />}`. Pe containerul modal/overlay: `onClick={() => setShowAmlModal(false)}` la primul click.
4. La unmount sau când `isAmlUser` devine false, resetează `showAmlModal` la true pentru următoarea sesiune AML.

### WebSocket role update
1. Backend: la `clear_deposit`, după commit, colectează `user_ids` (cei upgradeați AML→CEA).
2. `client_ws_manager.broadcast_to_users(user_ids, {"type": "role_updated", "data": {"role": "CEA"}})`.
3. Frontend: hook ascultă; la `role_updated` → `usersApi.getProfile()` → `setAuth(user, token)`.
4. Re-render: `effectiveRole` devine CEA, `isAmlUser` devine false, blur și modal dispar, conținutul funded se afișează.

## Faze (implementare logică)

### Faza 1 – Modal click-to-dismiss + blur persistă (frontend only)
1. În `DashboardPage.tsx`: stare `showAmlModal`, init `true` când `isAmlUser`.
2. Separare condiții: blur doar `isAmlUser`; modal `isAmlUser && showAmlModal`.
3. Adăugare `onClick` pe overlay/modal wrapper care setează `showAmlModal(false)`.
4. Testare: AML user, click oriunde → modal dispare, blur rămâne.

### Faza 2 – Client WebSocket + role update live
1. Backend: `ClientConnectionManager` cu map `user_id → [WebSocket]`, endpoint `WS /api/v1/client/ws` cu JWT.
2. Backend: în `clear_deposit`, după commit, broadcast `role_updated` către user IDs afectați.
3. Frontend: `clientRealtimeApi.connectWebSocket` în api.ts, tipuri `ClientWebSocketMessage`.
4. Frontend: hook `useClientRealtime` – connect, on `role_updated` → getProfile + setAuth.
5. Montare hook în Layout sau App (când autentificat).
6. Actualizare `app_truth.md` cu descrierea client WebSocket.

## Clarificări incluse

- „Click oriunde” = orice click în viewport (inclusiv pe modal) închide modalul AML.
- „Dashboard rămâne blurred” = overlay-ul de blur rămâne vizibil cât timp utilizatorul are rol AML, chiar dacă modalul este închis.
- „Live” = actualizare prin WebSocket când adminul execută clear deposit; nu polling.
