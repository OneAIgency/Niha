# 0010 – Evoluția statusului user în platformă (NDA → EUA)

Plan tehnic pentru fluxul complet de onboarding: de la cerere NDA până la status EUA (acces complet). Statusurile sunt unificate pentru `User.role` și `ContactRequest.status` unde se aplică.

---

## Context

- **Existent:** `UserRole` și `ContactStatus` au doar `ADMIN` și `NDA`. Backoffice poate aproba/respinge cereri NDA și crea user din cerere (user primește NDA). Pagina onboarding (KYC) și funding există; accesul e restricționat la ADMIN.
- **Scop:** Definirea întregii evoluții de status și a punctelor unde backoffice/client acționează, plus tranzițiile automate.

---

## Flux de status (verbatim din cerere)

1. **NDA** – User/contact trimite NDA; apare pentru review la backoffice (onboarding/requests și users).
2. **Back office analizează cererea NDA.** Da **REJECT** → clientul devine **REJECTED**. Aprobă → clientul devine **KYC**, primește user și parolă și acces la pagina **onboarding**.
3. **Onboarding:** User completează formularul KYC; ajunge la backoffice pentru analiză. Poate fi **REJECTED** sau aprobat → devine **APPROVED** și are acces la pagina de **funding**.
4. **Funding:** User completează datele despre transferul ordonat către companie; acestea apar în backoffice. User devine automat **FUNDING**. Așteaptă până când backoffice confirmă detaliile executării transferului de bani.
5. După confirmarea transferului, user devine **AML** și așteaptă ca backoffice/compliance să facă AML investigation. Poate primi **REJECTED** sau să fie aprobat →
6. **CEA.** Are acces să cumpere certificate CEA. După ce cumpară de toti banii, automat devine
7. **CEA_SETTLE** – perioada în care așteaptă să se deconteze tranzacția cu CEA. După decontare CEA, devine
8. **SWAP** – are acces la piața de swap (CEA → EUA). După ce toate CEA au fost preschimbate în EUA, devine
9. **EUA_SETTLE** – așteaptă ca toate tranzacțiile de swap CEA↔EUA să se deconteze; apoi devine
10. **EUA** – status final, acces complet.

---

## 1. Model de date (enum și coloane)

### 1.1 Enum unificat (User.role și ContactRequest.status)

**Fișiere:** `backend/app/models/models.py`, `backend/app/schemas/schemas.py`

- **UserRole** (și **ContactStatus** acolo unde se folosește același set):  
  `ADMIN`, `NDA`, `REJECTED`, `KYC`, `APPROVED`, `FUNDING`, `AML`, `CEA`, `CEA_SETTLE`, `SWAP`, `EUA_SETTLE`, `EUA`.
- `ADMIN` rămâne rol de sistem; nu face parte din fluxul de onboarding.
- Restul valorilor sunt etape în flux; pentru contact request se folosesc doar NDA și REJECTED (și eventual KYC dacă se marchează contactul ca „convertit” în user KYC).

### 1.2 Migrație DB

**Fișier nou:** `backend/alembic/versions/YYYY_MM_DD_user_contact_status_full_flow.py`

- Extindere enum `userrole`: adăugare valorilor noi (sau înlocuire tip cu noul set complet).
- Extindere enum `contactstatus`: cel puțin `NDA`, `REJECTED`; eventual `KYC` dacă contact request poate fi marcat ca „approved → KYC”.
- Mapare date existente: valorile curente (ADMIN, NDA) rămân; nu există încă alte valori în DB.

---

## 2. Backoffice – cerere NDA (pas 2)

### 2.1 Reject NDA

**Fișiere:** `backend/app/api/v1/admin.py`, frontend ContactRequestsTab / onboarding requests.

- **PUT /admin/contact-requests/{id}** cu `status: "REJECTED"`: deja există; se asigură că `ContactRequestUpdate.status` acceptă `REJECTED` și că enum-ul ContactStatus include REJECTED.
- Dacă pentru contact există deja user (creat din cerere), la reject NDA: fie se actualizează și userul la REJECTED (dacă business logic o cere), fie doar contactul devine REJECTED; trebuie decis și documentat în plan.
- Frontend: buton/acțiune „Reject” care trimite update status REJECTED; afișare status REJECTED în listă.

### 2.2 Approve NDA → user KYC, credențiale, acces onboarding

**Fișiere:** `backend/app/api/v1/admin.py` (`create_user_from_contact_request`), `backend/app/core/database.py` (seed), frontend onboarding/requests și users.

- **Comportament cerut:** „aprobă și clientul devine KYC, primește user și parolă și acces la pagina onboarding”.
- La creare user din contact request (endpoint existent `POST /admin/users/create-from-request`):
  - Setare **user.role = KYC** (nu NDA).
  - Setare **contact_request.status = KYC** (sau un status care să indice „approved, user created”; verbatim: „clientul devine KYC”).
- Trimitere credențiale: mod manual (parolă setată de admin) sau invitație (email cu link set password); deja suportat; doar rolul creatului devine KYC.
- **Acces onboarding:** rutele pentru `/onboarding` trebuie permise pentru user cu **role = KYC** (și eventual APPROVED, etc., în funcție de faza de acces). Astăzi `blockRoles={['NDA']}` redirecționează NDA către /onboarding; trebuie definit explicit: KYC (și NDA dacă se dorește) pot accesa doar /onboarding (formular KYC), nu /funding sau /cash-market.

**Frontend:**  
- După „Create user from request”, request-ul să poată fi marcat cu status KYC (sau echivalent).  
- Pagina de login și post-login: user cu KYC este redirecționat la `/onboarding` (getPostLoginRedirect și AuthGuard/blockRoles/allowedRoles).

---

## 3. Onboarding – KYC (pas 3)

### 3.1 Formular KYC și trimitere la backoffice

**Fișiere:** `backend/app/api/v1/onboarding.py`, `frontend/src` (onboarding KYC: KycUploadModal, OnboardingLayout, pagini onboarding).

- Fluxul existent: user încarcă documente KYC, `/onboarding/status` și submit.
- **Status user:** rămâne **KYC** până când backoffice aprobă sau respinge. Nu se schimbă automat la „submitted”; doar documentele au status (pending/approved/rejected). Backoffice vede userii KYC cu documente în **GET /backoffice/pending-users** (sau echivalent) și în tab-ul KYC Review.

### 3.2 Backoffice: approve / reject KYC

**Fișiere:** `backend/app/api/v1/backoffice.py` (approve_user, reject_user), frontend KYC review tab.

- **Approve:**  
  - Condiție: user.role == KYC (nu NDA).  
  - Acțiune: **user.role = APPROVED**; entity.kyc_status = APPROVED, verified = True (dacă e cazul).  
  - Rezultat: user are acces la **pagina de funding** (vezi secțiunea 4).
- **Reject:**  
  - Setare **user.role = REJECTED** (și eventual entity/kyc document status rejected).  
  - Frontend: buton Reject și eventual motiv; afișare REJECTED.

---

## 4. Funding – transfer ordonat (pas 4)

### 4.1 Client: completare date transfer

**Fișiere:** `backend/app/api/v1/deposits.py` (announce_deposit, wire-instructions, my-deposits), `backend/app/core/security.py` (get_approved_user), frontend Funding page.

- **Acces:** user cu **role = APPROVED** (și ADMIN) pot accesa pagina funding și endpoint-urile de deposit (wire instructions, announce deposit, my-deposits).
- **get_approved_user:** trebuie actualizat să permită **APPROVED** (și FUNDING, AML, CEA, … și ADMIN), nu doar ADMIN.
- La **announce_deposit** (POST): user raportează transferul ordonat; în backoffice apare cererea/deposit-ul.  
- **Tranziție automată (verbatim):** „Completează datele despre transfer … devine automat FUNDING.”  
  - La prima trimitere reușită a unui deposit (announce) pentru acel user/entity: **user.role = FUNDING**.  
  - Sau: user devine FUNDING la un anumit eveniment (ex. „deposit created, pending confirmation”); trebuie ales un singur punct (ex. după announce_deposit).

### 4.2 Backoffice: confirmare executare transfer

**Fișiere:** `backend/app/api/v1/backoffice.py` (confirmare deposit / confirm pending deposit), `backend/app/services/deposit_service.py`, eventual `backend/app/api/v1/deposits.py`.

- Backoffice confirmă primirea banilor și detaliile executării (flux existent: confirm deposit, status ON_HOLD, AML).
- **Tranziție (pas 5):** După ce backoffice confirmă transferul (deposit confirmed / cleared sau după ce AML e trecut), toți userii entity-ului cu **role = FUNDING** trebuie actualizați la **role = AML** (un singur punct definit: fie la confirm, fie la clear; verbatim: „Devine acum AML”).

---

## 5. AML (pas 5 → 6)

**Fișiere:** `backend/app/api/v1/deposits.py`, `backend/app/services/deposit_service.py`, backoffice AMLDepositsTab, AML clear/reject.

- **Existent:** deposit are `aml_status` (ON_HOLD, CLEARED, REJECTED); clear_hold creditează entity și poate upgrada useri.
- **Reject AML:**  
  - La reject deposit (AML): setare **user.role = REJECTED** pentru userii entity-ului care sunt în AML (sau doar cei care au acel deposit ca sursă – de decis).  
- **Approve AML (clear):**  
  - La clear deposit: pentru entity, userii cu **role = AML** trec la **role = CEA**.  
  - Creditează entity (EUR) ca acum; plus tranziția de role AML → CEA.

---

## 6. CEA – cumpărare certificate (pas 6 → 7)

**Fișiere:** `backend/app/core/security.py` (get_funded_user), `backend/app/api/v1/cash_market.py`, frontend cash-market, order/balance logic.

- **Acces CEA:** user cu **role = CEA** (și ADMIN) au acces la piața CEA (cash market – cumpărare CEA).  
- **get_funded_user** trebuie redefinit: cel puțin **CEA, CEA_SETTLE, SWAP, EUA_SETTLE, EUA** (și ADMIN) pot accesa cash market / swap în funcție de fază; sau se introduc dependențe dedicate (get_cea_user, get_swap_user etc.).
- **Tranziție automată (verbatim):** „După ce cumpară de toti banii, automat devine CEA_SETTLE.”  
  - Definiție: „tot banii” = balance EUR al entity-ului ajunge 0 (sau sub un prag) după ce au fost puse ordine/executate cumpărări CEA.  
  - Punct de verificare: după executare order CEA sau la un job periodic care verifică entity.balance_amount (EUR) și ordine deschise; la 0 EUR (și eventual toate ordinele CEA fillate), setare **user.role = CEA_SETTLE** pentru userii entity-ului cu role CEA.

---

## 7. CEA_SETTLE (pas 7 → 8)

**Fișiere:** `backend/app/models/models.py` (SettlementBatch, SettlementStatus), `backend/app/services/settlement_*.py`, job-uri/monitoring.

- **Existent:** settlement batches pentru CEA (CEA_PURCHASE) cu status (PENDING, SETTLED, etc.).
- **Regulă:** Când toate settlement batch-urile CEA pentru entity (sau pentru order-urile acelui user/entity) sunt **SETTLED**, userii entity-ului cu **role = CEA_SETTLE** trec la **role = SWAP**.
- Punct de verificare: la update status batch la SETTLED sau la un job periodic care verifică toate batch-urile CEA ale entity-ului; dacă toate sunt SETTLED, tranziție CEA_SETTLE → SWAP.

---

## 8. SWAP (pas 8 → 9)

**Fișiere:** `backend/app/api/v1/swaps.py`, `backend/app/core/security.py`, frontend swap page.

- **Acces swap:** user cu **role = SWAP** (și ADMIN) au acces la piața de swap (CEA → EUA).
- **Tranziție automată (verbatim):** „După ce toate CEA au fost preschimbate în EUA, devine EUA_SETTLE.”  
  - Definiție: balance CEA al entity-ului = 0 (sau toate swap-urile pentru acea entity sunt finalizate).  
  - La verificare (după swap sau periodic): dacă entity nu mai are CEA (sau toate swap-urile sunt completed), **user.role = EUA_SETTLE** pentru userii entity-ului cu role SWAP.

---

## 9. EUA_SETTLE (pas 9 → 10)

**Fișiere:** settlement batches pentru SWAP (CEA→EUA), settlement monitoring/processor.

- **Existent:** SettlementType.SWAP_CEA_TO_EUA, batch-uri cu status.
- **Regulă:** Când toate batch-urile de tip SWAP_CEA_TO_EUA pentru entity sunt **SETTLED**, userii entity-ului cu **role = EUA_SETTLE** trec la **role = EUA**.
- Punct de verificare: la SETTLED pe batch sau job periodic; tranziție EUA_SETTLE → EUA.

---

## 10. EUA (pas 10)

- **Rol final:** user cu **role = EUA** (și ADMIN) au acces complet (dashboard, cash market EUA, swap dacă se păstrează, etc.).  
- **get_funded_user** (sau echivalent) trebuie să includă EUA pentru toate rutele „funded”.

---

## 11. Frontend – rute și redirect

**Fișiere:** `frontend/src/App.tsx`, `frontend/src/utils/redirect.ts`, `frontend/src/components/layout/Header.tsx`.

- **Redirect după login (getPostLoginRedirect):**  
  - NDA → /onboarding (sau login page dacă nu are încă cont).  
  - KYC → /onboarding (formular KYC).  
  - APPROVED → /funding.  
  - FUNDING, AML → /funding (sau pagină „în așteptare”).  
  - CEA, CEA_SETTLE → /cash-market (sau pagină CEA).  
  - SWAP, EUA_SETTLE → /swap (sau pagină swap).  
  - EUA, ADMIN → /dashboard (sau cash-market).  
- **AuthGuard / RoleProtectedRoute:**  
  - /onboarding: allowedRoles = [KYC, NDA] (sau block doar REJECTED).  
  - /funding: allowedRoles = [APPROVED, FUNDING, AML] (+ ADMIN).  
  - /cash-market: allowedRoles = [CEA, CEA_SETTLE, SWAP, EUA_SETTLE, EUA, ADMIN].  
  - /swap: allowedRoles = [SWAP, EUA_SETTLE, EUA, ADMIN].  
  - /dashboard: allowedRoles = [EUA, ADMIN] (sau toți „funded”).  
- **Header nav links:** afișare link-uri în funcție de role (Funding, Cash Market, Swap, Dashboard) conform fazelor de mai sus.

---

## 12. Backoffice – filtre și acțiuni

**Fișiere:** `backend/app/api/v1/backoffice.py`, `backend/app/api/v1/admin.py`, frontend BackofficeOnboardingPage, UsersPage, KYC tab, PendingDepositsTab, AMLDepositsTab.

- **Contact requests:** filtrare după status NDA, REJECTED, KYC; acțiuni Reject (→ REJECTED), Create user (→ user KYC, contact KYC).  
- **Users:** filtrare după role (KYC, APPROVED, FUNDING, AML, CEA, …); unde e cazul, butoane Approve / Reject (KYC → APPROVED / REJECTED).  
- **Deposits:** confirmare transfer (FUNDING → AML); AML clear (→ CEA) sau reject (→ REJECTED).  
- **Dashboard / statistici:** număr utilizatori per status; eventual grafice sau liste per fază.

---

## 13. Rezumat fișiere cheie

| Zonă | Fișiere |
|------|--------|
| Enum + migrație | `backend/app/models/models.py` (UserRole, ContactStatus), `backend/app/schemas/schemas.py`, `backend/alembic/versions/` |
| Auth / role de acces | `backend/app/core/security.py` (get_approved_user, get_funded_user, eventual get_cea_user, get_swap_user) |
| Admin NDA | `backend/app/api/v1/admin.py` (update_contact_request, create_user_from_contact_request) |
| Backoffice KYC / users | `backend/app/api/v1/backoffice.py` (get_pending_users, approve_user, reject_user) |
| Deposits / funding | `backend/app/api/v1/deposits.py`, `backend/app/api/v1/backoffice.py`, `backend/app/services/deposit_service.py` |
| AML | `backend/app/services/deposit_service.py` (clear_deposit, reject_deposit), backoffice AML tab |
| Settlement | `backend/app/models/models.py` (SettlementBatch), `backend/app/services/settlement_processor.py`, `settlement_monitoring.py` |
| Cash market / swap | `backend/app/api/v1/cash_market.py`, `backend/app/api/v1/swaps.py` |
| Frontend routing | `frontend/src/App.tsx`, `frontend/src/utils/redirect.ts`, `frontend/src/components/layout/Header.tsx` |
| Frontend types | `frontend/src/types/index.ts` (UserRole) |
| Backoffice UI | `frontend/src/pages/BackofficeOnboardingPage.tsx`, `frontend/src/components/backoffice/` (ContactRequestsTab, KYC, PendingDepositsTab, AMLDepositsTab), `frontend/src/pages/UsersPage.tsx` |

---

## 14. Ordinea de implementare recomandată

1. **Data layer:** Extindere UserRole și ContactStatus + migrație Alembic.  
2. **Backoffice NDA:** Reject (REJECTED), Approve → create user cu role KYC; contact status KYC/REJECTED.  
3. **Acces onboarding:** KYC poate accesa /onboarding; redirect și AuthGuard.  
4. **Backoffice KYC:** Approve → APPROVED, Reject → REJECTED.  
5. **Funding:** APPROVED acces /funding; announce_deposit; tranziție automată → FUNDING.  
6. **Backoffice confirmare transfer:** FUNDING → AML la confirmare.  
7. **AML:** Clear → CEA; Reject → REJECTED.  
8. **CEA:** Acces cash market; tranziție automată „tot banii” → CEA_SETTLE.  
9. **CEA_SETTLE:** La toate CEA settlements SETTLED → SWAP.  
10. **SWAP:** Acces swap; la 0 CEA → EUA_SETTLE.  
11. **EUA_SETTLE:** La toate swap settlements SETTLED → EUA.  
12. **EUA:** Acces complet; ajustări finale get_funded_user și rute.

Tranzițiile automate (FUNDING la announce, CEA_SETTLE, SWAP, EUA_SETTLE, EUA) pot fi implementate fie în același request care declanșează evenimentul, fie într-un job periodic care verifică condițiile; trebuie ales și menținut consistent.
