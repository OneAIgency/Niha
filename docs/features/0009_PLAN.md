# 0009 – PENDING user access only to onboarding

## Description

Un utilizator **PENDING** care are user și parolă are acces **doar** la pagina onboarding. Doar la onboarding.

- PENDING (authenticated) poate accesa doar zona de onboarding: `/onboarding`, sub-rute (`/onboarding/market-overview`, `/onboarding/about-nihao`, etc.), `/onboarding1`, `/learn-more`, și dacă e cazul `/setup-password` (flux setare parolă după invitație).
- PENDING nu poate accesa niciun alt drum protejat: `/profile`, `/dashboard`, `/funding`, `/cash-market`, `/settings`, `/users`, `/components`, backoffice, etc. Orice acces la aceste rute redirecționează către `/onboarding`.

## Context

- Rolurile existente: `UserRole.PENDING`, `APPROVED`, `FUNDED`, `ADMIN` (backend: `backend/app/models/models.py`, `UserRole`; frontend: `frontend/src/types/index.ts`).
- După login, redirecționarea e deja corectă: `getPostLoginRedirect` trimite PENDING la `/onboarding` (`frontend/src/utils/redirect.ts`).
- `FundedRoute` și `ApprovedRoute` redirecționează deja PENDING către `/onboarding` (`frontend/src/App.tsx`).
- `OnboardingRoute` în prezent nu face niciun guard (comentariu: "temporarily allowing all for testing") — doar randează children.
- `ProtectedRoute` și `DashboardRoute` cer doar `requireAuth`; nu exclud PENDING, deci un user PENDING poate accesa acum `/profile`, `/dashboard`, `/components` dacă introduce URL-ul.
- Backend: API-ul de onboarding folosește `get_current_user` fără verificare de rol (`backend/app/api/v1/onboarding.py`), deci PENDING poate folosi endpoint-urile de onboarding. Restul API-urilor (deposits, settlement, users, etc.) restricționează pe rol; nu e nevoie de modificări pentru PENDING dacă frontend-ul nu mai expune rutele respective pentru PENDING.

## Fișiere și funcții de modificat

### Frontend

1. **`frontend/src/App.tsx`**
   - **AuthGuard**: Extinde cu parametri opționali `blockRoles?: UserRole[]` și (opțional) `redirectWhenBlocked?: string`. După verificarea `requireAuth` și a `allowedRoles`, dacă `blockRoles` este prezent și `user.role` este în `blockRoles`, redirecționare către `redirectWhenBlocked` (implicit `/onboarding`). Ordinea: verificare autentificare → verificare allowedRoles → verificare blockRoles.
   - **ProtectedRoute**: Folosește AuthGuard cu `blockRoles={['PENDING']}` și `redirectWhenBlocked="/onboarding"` (sau numele parametrului ales), astfel încât userii PENDING să fie redirecționați la `/onboarding` când încearcă `/profile` sau `/components`.
   - **DashboardRoute**: La fel — AuthGuard cu `blockRoles={['PENDING']}` și redirect la `/onboarding`, astfel încât PENDING să nu poată accesa `/dashboard`.
   - **OnboardingRoute**: Înlocuiește implementarea care "allow all" cu AuthGuard cu `requireAuth={true}` și fără `blockRoles`, astfel încât doar utilizatori autentificați (inclusiv PENDING) să vadă onboarding-ul. Dacă se dorește ca anumite pagini de onboarding să rămână publice (fără login), se poate face excepție doar pentru acele rute; cerința utilizatorului este că "PENDING are acces la onboarding", deci cel puțin pentru PENDING trebuie să fie nevoie de autentificare pentru a vedea onboarding.

2. **`frontend/src/utils/redirect.ts`**
   - Fără modificări obligatorii; `getPostLoginRedirect` pentru PENDING → `/onboarding` este deja corect.

### Backend

- **`backend/app/api/v1/onboarding.py`**: Nu necesită modificări; folosește `get_current_user` și nu restricționează pe rol — PENDING poate folosi API-ul.
- Verificare rapidă (audit): asigură-te că endpoint-urile care nu trebuie accesate de PENDING (ex: listă deposits pentru entitate, settlement, etc.) depind de rol (APPROVED/FUNDED/ADMIN) în `backend/app/core/security.py` sau în rute; de obicei deja o fac.

## Algoritm / flux

1. User PENDING se loghează → `getPostLoginRedirect` → `/onboarding` (deja implementat).
2. User PENDING navighează la `/onboarding` sau orice subrută onboarding → OnboardingRoute cu `requireAuth={true}` și fără `blockRoles` → acces permis.
3. User PENDING navighează la `/dashboard`, `/profile`, `/components` → ProtectedRoute / DashboardRoute cu `blockRoles={['PENDING']}` → redirect la `/onboarding`.
4. User PENDING navighează la `/funding` sau rute Funded → deja redirecționat de ApprovedRoute / FundedRoute la `/onboarding` sau `/funding`; PENDING merge la `/onboarding`.
5. Rute backoffice sunt deja protejate cu AdminRoute → PENDING nu are ADMIN, deci nu are acces.

## Consistență

- Păstrează un singur punct de decizie pentru redirect-uri (AuthGuard); nu adăuga logică de redirect pentru PENDING în alte componente (ex. LoginPage, layout-uri).
- Design system / Tailwind: fără schimbări de UI; doar restricții de rutare.
- Dacă există `docs/commands/interface.md`, nu e nevoie de specificații UI noi pentru această funcționalitate (doar routing).

## Faze

- O singură fază: modificări în `App.tsx` (AuthGuard, ProtectedRoute, DashboardRoute, OnboardingRoute). Opțional verificare backend că niciun endpoint sensibil nu e accesibil de PENDING.
