# 0017 – Create Liquidity: volume bounds, max orders per level, order book depth curve

## Context

- **Create Liquidity** (Backoffice): BID Side (CEA Buyers) and ASK Side (CEA Sellers) cards with Target Total Value, Min Order, Max Order, Price Range (%), Orders count, and **Diversity (1-10)**.
- **Order book** (Cash Market): each row shows price, quantity, and a **depth bar** (cumulative liquidity). User wants depth shown as a **smooth, elegant curve** instead of rectangular bars, for both BID and ASK.
- **Auto trader**: ensure it works for both BID and ASK (backend already has CEA_BID / CEA_ASK; verification only).

User requirements (verbatim):

- *"la valoarea 10 te asiguri sa ai volume la ordine intre minim si maxim"* — when Diversity is 10, ensure each order’s volume (EUR) is strictly between Min Order and Max Order.
- *"mai introducem un input cu numar maxim de ordine pe nivel de pret"* — add an input for **maximum number of orders per price level** (for both BID and ASK).
- *"nu mai afisam lichiditatea ca pe bars in linia de ordin. o afisam ca pe o functie cursiva si eleganta afisata intre background ordine si valorinle din fiecare ordin"* — do not show liquidity as bars on the order line; show it as a smooth, elegant curve between the order row background and the order values. Same for BID and ASK.
- *"verifica daca auto trader functioneaza si pentru bid si pentru ask"* — verify auto trader works for both bid and ask.

---

## 1. Volume between Min and Max when Diversity = 10

**File:** `frontend/src/pages/CreateLiquidityPage.tsx`

**Function:** `generateRandomOrders` (approx. lines 299–446).

**Current behaviour:**  
`effectiveMin` and `effectiveMax` are derived from `avgOrderSize` and `variationPercent` and can extend **outside** the user’s Min/Max Order:

- `effectiveMin = Math.min(minOrder, avgOrderSize * (1 - variationPercent));`
- `effectiveMax = Math.max(maxOrder, avgOrderSize * (1 + variationPercent));`

So at high diversity, generated order EUR can be below Min Order or above Max Order.

**Required changes:**

- Clamp effective range to user bounds:  
  `effectiveMin = Math.max(minOrder, avgOrderSize * (1 - variationPercent));`  
  `effectiveMax = Math.min(maxOrder, avgOrderSize * (1 + variationPercent));`
- After computing `orderEur` (line ~421), clamp it to `[minOrder, maxOrder]`:  
  `orderEur = Math.max(minOrder, Math.min(maxOrder, orderEur));`  
  then use this clamped value for `quantity`, `total_eur`, and `remainingEur`.
- Ensure `minForThis` / `maxForThis` (lines 416–417) never allow values outside `[minOrder, maxOrder]` (e.g. `minForThis = Math.max(effectiveMin, minOrder)`, `maxForThis = Math.min(effectiveMax, maxOrder)`; the above clamp is the final guarantee).

No new state or UI; logic-only change in `generateRandomOrders`.

---

## 2. Max orders per price level – new input

**File:** `frontend/src/pages/CreateLiquidityPage.tsx`

**State:** Add two new state variables, e.g.:

- `bidMaxOrdersPerLevel` (default e.g. `'5'`)
- `askMaxOrdersPerLevel` (default e.g. `'5'`)

**UI:** In the same grid/section where **Diversity (1-10)** lives:

- **BID card:** add one more field, e.g. label *"Max orders per price level"*, with a `NumberInput` bound to `bidMaxOrdersPerLevel` (integer, reasonable min/max e.g. 1–20).
- **ASK card:** same label and `NumberInput` bound to `askMaxOrdersPerLevel`.

**Logic:** In `generateRandomOrders`:

- Add a parameter, e.g. `maxOrdersPerLevel: number` (e.g. default 5).
- Replace the hardcoded “1–5 orders per level” logic with this cap:
  - When building `levelWeights`, use a max of `maxOrdersPerLevel` instead of 5 (e.g. `1 + Math.floor(Math.random() * maxOrdersPerLevel)`).
  - When capping `ordersPerLevel` (currently `Math.max(1, Math.min(5, scaled))`), use `maxOrdersPerLevel` instead of 5.
  - In the while-loops that adjust `ordersPerLevel` to hit `targetOrderCount`, replace the hardcoded `8` with `maxOrdersPerLevel` (or a value derived from it) so we never exceed the user’s max per level.

**Call sites:** When calling `generateRandomOrders` for BID and ASK, pass the parsed value of `bidMaxOrdersPerLevel` / `askMaxOrdersPerLevel` (e.g. `parseInt(bidMaxOrdersPerLevel, 10) || 5`).

---

## 3. Order book depth: smooth curve instead of bars

**Files:**

- `frontend/src/components/cash-market/OrderBookRow.tsx` — main change (depth visualization per row).
- Optionally `frontend/src/components/cash-market/ProfessionalOrderBook.tsx` — only if needed to pass extra props or wrap layout; otherwise no change.

**Current behaviour (OrderBookRow):**  
A rectangular div represents depth:

- `style={{ width: `${depthPercentage}%` }}`
- Class `depth` for colour; position `right-0` (BID) or `left-0` (ASK).

**Required behaviour:**  
Replace the rectangular bar with a **smooth, elegant curve** for the depth fill, so the boundary between “depth” and “no depth” is a curve (e.g. ease-in/ease-out or similar), not a vertical line. The fill should still sit between the row background and the order values (Total, Quantity, Price, etc.), for both BID and ASK.

**Implementation options (choose one and keep it consistent for BID and ASK):**

- **Option A – SVG:**  
  One SVG per row: a path that draws a smooth curve (e.g. quadratic/bezier) from 0 to the depth width; fill under the curve with the same colour as current depth; row content stays above/on top (z-index). The curve can be a gentle S or a single curved edge (e.g. right edge for BID, left for ASK) so it looks “cursiva” (smooth).
- **Option B – CSS clip-path / mask:**  
  A full-width block with the same fill colour, and a `clip-path` or mask that uses a curve (e.g. `path()` or `polygon()` with many points approximating a curve) so the visible fill has a curved edge.
- **Option C – Gradient:**  
  A linear or radial gradient that fades so the depth appears to “rise” smoothly from the side (e.g. BID from right, ASK from left), giving a soft, curved-like transition instead of a hard bar edge.

Keep existing semantics: depth percentage still drives the “amount” of liquidity (e.g. curve width or gradient stop). Preserve `depthPosition` (BID: right, ASK: left) and existing colour classes. No change to layout structure of the row (grid, labels, etc.); only the depth visualization changes from a rectangle to a curved fill.

---

## 4. Auto trader – BID and ASK verification

**Backend:**

- `backend/app/services/auto_trade_executor.py`: `determine_market_key` returns `"CEA_BID"` for `CEA_BUYER` and `"CEA_ASK"` for `CEA_SELLER`. Rules and market settings are keyed by `market_key`; the executor loop runs all rules (BID and ASK).
- `backend/app/api/v1/admin.py`: `get_auto_trade_market_settings` and related endpoints handle `CEA_BID` and `CEA_ASK`; `_sync_auto_trade_rules` maps market key to `MarketMakerType.CEA_BUYER` vs `CEA_SELLER`.

**Verification (no code change required in plan):**

- Confirm in code (or via manual test) that:
  - Enabling CEA_BID and CEA_ASK in Liquidity Engine creates/runs rules for both sides.
  - Placed orders appear on the correct side of the book (BID vs ASK).

No backend or frontend feature changes are required for “auto trader works for bid and ask”; only verification that existing behaviour covers both.

**Verification done (code):** `auto_trade_executor.determine_market_key` returns `CEA_BID` for `CEA_BUYER` and `CEA_ASK` for `CEA_SELLER`; `admin.py` maps both keys to rules and market settings; executor runs all rules (BID and ASK).

---

## 5. Files and functions summary

| Area | File | Changes |
|------|------|--------|
| Volume min/max at diversity 10 | `frontend/src/pages/CreateLiquidityPage.tsx` | `generateRandomOrders`: clamp `effectiveMin`/`effectiveMax` to `[minOrder, maxOrder]`; clamp final `orderEur` to `[minOrder, maxOrder]`; ensure `minForThis`/`maxForThis` respect user bounds. |
| Max orders per level | `frontend/src/pages/CreateLiquidityPage.tsx` | New state `bidMaxOrdersPerLevel`, `askMaxOrdersPerLevel`; new NumberInputs in BID/ASK cards; `generateRandomOrders(..., maxOrdersPerLevel)`; use it in levelWeights, ordersPerLevel cap, and while-loop cap. |
| Depth curve | `frontend/src/components/cash-market/OrderBookRow.tsx` | Replace rectangular depth div with smooth curve (SVG path, clip-path, or gradient) for both BID and ASK; keep same depth percentage and colours. |
| Auto trader | Backend (reference only) | Verification only: executor and admin API already support CEA_BID and CEA_ASK. |

---

## 6. Consistency and style

- Use existing design tokens (e.g. `navy-*`, `emerald-*`, `red-*`); no `slate-*`/`gray-*` or hardcoded hex.
- NumberInputs for max orders per level: same pattern as Orders and Diversity (integer, sensible min/max).
- Order book: preserve accessibility (e.g. `aria-hidden` on decorative depth; keep `aria-label` and keyboard behaviour on the row).

---

## 7. No mock data

All behaviour must use real data (order book from API, Create Liquidity from real market makers and balances). No mock or demo data.
