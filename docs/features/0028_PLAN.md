# 0028 – Modal confirmare tranzacție CEA Cash + dezactivare acces cash market

## Descriere

După ce un client CEA cumpără CEA din cash market, apare un modal care confirmă tranzacția (volum CEA cumpărat, preț mediu, ticket number). Imediat accesul la cash market este dezactivat. La click pe butonul din modal, userul este redirecționat către dashboard.

## Context

- Ruta `/cash-market` folosește **CashMarketProPage** (`frontend/src/pages/CashMarketProPage.tsx`), nu CashMarketPage. CashMarketProPage execută market order dar **nu** afișează niciun modal de confirmare; doar face `refresh()` la date.
- **CashMarketPage** (`frontend/src/pages/CashMarketPage.tsx`) are deja un modal de succes (volum, preț mediu, Order Ticket, cost, comision) și navigare la dashboard la click – dar nu este pagina montată pe `/cash-market`.
- După cumpărare, backend poate face tranziția **CEA → CEA_SETTLE** când soldul EUR al entity devine 0 (`role_transitions.transition_cea_to_cea_settle_if_eur_zero`, apelat din `order_matching.execute_market_buy_order`).
- **FundedRoute** pentru `/cash-market` permite doar `['CEA', 'ADMIN', 'MM']`; redirect pentru restul e `/swap`. Deci CEA_SETTLE nu mai poate accesa cash market (link-ul dispare din Header deoarece `canCashMarket = ['CEA', 'MM']` în `Header.tsx`).
- API `POST /cash-market/order/market` returnează `OrderExecutionResponse`: `success`, `order_id`, `total_quantity`, `weighted_avg_price`, `total_cost_net`, `platform_fee`, `eur_balance`, `certificate_balance`, etc. Nu există câmp `ticket_id` în răspuns; se folosește **order_id** ca ticket number.

## Fișiere relevante

| Fișier | Modificare |
|--------|------------|
| `frontend/src/pages/CashMarketProPage.tsx` | Adăugare state pentru rezultatul ordinului; după `executeMarketOrder` reușit: refetch user (`GET /users/me`), setare rezultat, afișare modal confirmare; la click pe buton: navigate `/dashboard`. |
| `frontend/src/components/common/Modal.tsx` (sau unde există) | Doar folosit; fără schimbări dacă API-ul Modal existent e suficient. |
| `frontend/src/services/api.ts` | Fără schimbări (tipul de return pentru `executeMarketOrder` e deja potrivit). |
| `frontend/src/stores/authStore.ts` (sau echivalent) | Trebuie apelat refetch user după success (de ex. `fetchUser()` / `getMe()`) ca auth store să primească rolul actualizat (CEA_SETTLE). |

## Detalii de implementare

### 1. Modal confirmare în CashMarketProPage

- După `cashMarketApi.executeMarketOrder(...)` cu succes:
  - Reține rezultatul (order_id, total_quantity, weighted_avg_price, total_cost_net, platform_fee, etc.).
  - Refetch user: apel la endpoint-ul care returnează userul curent (ex. `GET /users/me` sau funcție din auth store) și actualizare auth store, astfel încât dacă backend a făcut CEA → CEA_SETTLE, frontend să aibă rolul actualizat.
  - Închide panelul de order (dacă e cazul) și deschide modalul de confirmare.
- Conținut modal (verbatim cerință): **volum CEA cumpărat**, **preț mediu**, **ticket number**. Poți reutiliza structura din CashMarketPage (Tranzactie confirmata, Order Ticket / ticket number = `order_id` afișat clar, volum CEA, preț mediu per CEA, cost total, comision, notă settlement T+3).
- Un singur buton de acțiune: la click închide modalul și face `navigate('/dashboard')`.

### 2. Acces cash market dezactivat „imediat”

- „Imediat” se realizează prin: (1) refetch user după success (pasul de mai sus); (2) Header folosește deja `canCashMarket = ['CEA', 'MM']` – deci pentru CEA_SETTLE link-ul CEA Cash dispare; (3) FundedRoute redirectează orice user care nu e CEA/ADMIN/MM către `/swap`. Nu e nevoie de logică suplimentară pentru a „dezactiva” accesul; este consecință a rolului actualizat după refetch.
- Opțional: dacă utilizatorul e deja CEA_SETTLE când modalul e deschis (ex. a rămas pe pagină), la click oricum merge la dashboard; nu e necesar să blochezi și ruta în timp ce modalul e deschis, doar să refetch și să oferi un singur CTA către dashboard.

### 3. Flux rezumat

1. User (CEA) pe Cash Market → plasează ordin market BUY CEA.
2. Backend execută ordinul; eventual CEA → CEA_SETTLE dacă EUR = 0.
3. Frontend primește răspuns success; refetch `/users/me` și actualizare auth store.
4. Frontend afișează modal: volum CEA cumpărat, preț mediu, ticket number (order_id).
5. La click pe buton: închide modal, `navigate('/dashboard')`. Accesul la cash market este deja „dezactivat” prin rol (link ascuns, iar la orice încercare ulterioară de acces la `/cash-market`, FundedRoute redirecționează).

### 4. Consistență UI

- Folosește componente din `frontend/src/components/common/` (ex. Modal) și token-uri design (navy, emerald, amber) conform `frontend/docs/DESIGN_SYSTEM.md` și `app_truth.md` §9. Textul din modal poate fi în română (Tranzactie confirmata, Volum CEA cumparat, Pret mediu per CEA, Ticket number, Inapoi la Dashboard) ca în CashMarketPage.

### 5. Fără mock/cache

- Toate datele din modal provin din răspunsul real al API-ului `POST /cash-market/order/market` și din user refetched; fără date mock sau cache pentru această funcționalitate.
