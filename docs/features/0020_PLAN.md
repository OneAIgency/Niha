# 0020 – Withdrawals in Deposit History, Ticketing și Vizibilitate în Logging

## Context

În modalul User Detail (tab Assets), secțiunea **Deposit History** afișează doar depozitele wire (din flow-ul announce → confirm → clear). **Retragerile** (withdrawals) făcute prin Add Asset modal nu apar în acest istoric. De asemenea, operațiunile add-asset (deposit și withdraw) nu creează ticket-uri în sistemul de audit, deci nu sunt vizibile în `/backoffice/logging`.

Cerințe (verbatim):

- *"Asigura-te ca retragerile apar in Deposit history"*
- *"si ca sunt inregistrate in sistemul de ticketing"*
- *"si vizibile in http://localhost:5173/backoffice/logging"*

---

## Stare curentă

1. **Deposit History (User Detail, tab Assets)**  
   - Afișează doar `deposits` de la `GET /backoffice/deposits?entity_id=...` — depozite wire (modelul Deposit).  
   - `getEntityAssets` returnează `recentTransactions` (AssetTransaction cu DEPOSIT și WITHDRAWAL), dar frontend-ul nu le folosește în secțiunea Deposit History.

2. **Ticketing**  
   - Endpoint-ul `add_asset_to_entity` din `backoffice.py` nu apelează `TicketService.create_ticket`.

3. **Logging page**  
   - Afișează ticket-uri din `TicketLog` (All Tickets, Search, etc.). Odată ce add-asset creează ticket-uri, acestea vor apărea automat în logging.

---

## Fișiere de modificat

### Backend

| Fișier | Modificări |
|--------|------------|
| `backend/app/api/v1/backoffice.py` | În `add_asset_to_entity`: apel la `TicketService.create_ticket` după crearea `AssetTransaction`, cu `action_type` = `ENTITY_ASSET_DEPOSIT` sau `ENTITY_ASSET_WITHDRAWAL`, `entity_type` = `AssetTransaction`, `entity_id` = ID-ul `AssetTransaction`-ului, `user_id` = admin care execută, `status` = SUCCESS, `tags` = `["entity_asset", "deposit"]` sau `["entity_asset", "withdrawal"]`, `after_state` cu rezumatul tranzacției |

### Frontend

| Fișier | Modificări |
|--------|------------|
| `frontend/src/pages/UsersPage.tsx` | În `loadDeposits`: în paralel cu cele existente, apel la `backofficeApi.getEntityTransactions(entityId)` (sau folosirea `recentTransactions` din `getEntityAssets`). Transmiterea unei liste unificate `depositsAndTransactions` către `UserDetailModal`. |
| `frontend/src/components/users/UserDetailModal.tsx` | În `DepositsTab`: extindere tipului `deposits` sau introducere tip unificat pentru wire deposits + AssetTransaction; afișare retrageri (WITHDRAWAL) în același format vizual ca depozitele, cu icon/badge distinct (ex. Minus/roșu pentru withdraw). Secțiunea poate rămâne „Deposit History” sau fi redenumită în „Deposit & Withdrawal History”. |
| `frontend/src/types/index.ts` | Dacă e nevoie, tip nou pentru item unificat (wire deposit sau AssetTransaction). |

---

## Detalii tehnice

### 1. Backend – Ticketing pentru add-asset

1. După `db.add(transaction)` și înainte de `await db.commit()`, apel la `TicketService.create_ticket`:
   - `action_type`: `"ENTITY_ASSET_DEPOSIT"` sau `"ENTITY_ASSET_WITHDRAWAL"` în funcție de `transaction_type`
   - `entity_type`: `"AssetTransaction"`
   - `entity_id`: `transaction.id`
   - `user_id`: `admin_user.id`
   - `status`: `TicketStatus.SUCCESS`
   - `after_state`: dict cu `asset_type`, `amount`, `balance_before`, `balance_after`, `operation`
   - `tags`: `["entity_asset", "deposit"]` sau `["entity_asset", "withdrawal"]`

2. Pattern similar cu `market_maker_service.py` (linia 156): `action_type=f"ASSET_{transaction_type.value}"`. Pentru entity add-asset, se preferă `ENTITY_ASSET_DEPOSIT` / `ENTITY_ASSET_WITHDRAWAL` pentru diferențiere față de MM.

### 2. Frontend – Date pentru Deposit History

Opțiune recomandată: utilizarea datelor existente din `getEntityAssets`, care returnează deja `recent_transactions` (AssetTransaction, inclusiv WITHDRAWAL).

1. În `loadDeposits`, `assetsResponse` conține `recentTransactions` (sau `recent_transactions` după normalizare).
2. Construire listă unificată:
   - Wire deposits (Deposit) — cu `amount`, `currency`, `status`, `createdAt`, `wireReference`, `notes`
   - AssetTransactions — cu `amount` (poate fi negativ pentru WITHDRAWAL), `asset_type` mappat la currency (EUR) sau label (CEA/EUA), `transaction_type`, `created_at`, `notes`
3. Sortare comună după dată (descrescător).
4. Transmitere către `DepositsTab` ca prop unificat (ex. `depositAndWithdrawalHistory`).

### 3. Frontend – UI pentru withdrawals

- Wire deposit: păstrează layout curent (DollarSign, amount pozitiv, badge status).
- AssetTransaction WITHDRAWAL: același card, dar:
  - Icon distinct (ex. `ArrowDownCircle` sau `Minus`) în roșu/amber
  - Amount afișat cu minus sau prefix „-” (ex. „-€1,000.00”)
  - Badge „WITHDRAWAL” (stil secondary/danger)
- AssetTransaction DEPOSIT (add-asset): același stil ca depozitul wire, cu badge „DEPOSIT” sau „Added”.

### 4. Logging page

- Fără modificări de pagină. Ticket-urile noi vor apărea în:
  - **All Tickets** – automat
  - **Search** – filtru după `action_type` (ENTITY_ASSET_DEPOSIT, ENTITY_ASSET_WITHDRAWAL) sau `tags` (entity_asset)

---

## Algoritm unificare listă (frontend)

1. `wireDeposits` ← `depositList` (GET /backoffice/deposits)
2. `assetTxs` ← `assetsResponse.recentTransactions` (sau `getEntityTransactions` dacă se preferă endpoint separat)
3. Transformare `assetTxs` în format afișabil: `{ id, type: 'asset_tx', transactionType, amount, assetType, createdAt, notes }`
4. Transformare `wireDeposits` în format afișabil: `{ id, type: 'wire_deposit', amount, currency, status, createdAt, wireReference, notes }`
5. Merge: `[...wireDeposits, ...assetTxs]`
6. Sortare după `createdAt` desc
7. Limitare la N itemi (ex. 50) pentru performanță

---

## Referințe

- `app_truth.md` §8 – Add Asset (deposit/withdraw), POST add-asset
- `backend/app/api/v1/backoffice.py` – `add_asset_to_entity`, `get_entity_assets`, `get_entity_transactions`
- `backend/app/services/ticket_service.py` – `create_ticket`
- `backend/app/services/market_maker_service.py` – exemplu `ASSET_{transaction_type}`
- `frontend/src/components/users/UserDetailModal.tsx` – `DepositsTab`, secțiunea Deposit History
- `frontend/src/pages/UsersPage.tsx` – `loadDeposits`
- `frontend/src/services/api.ts` – `getEntityAssets`, `getEntityTransactions`, `getDeposits`
